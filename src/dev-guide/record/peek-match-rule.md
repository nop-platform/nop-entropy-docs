# PeekMatchRule DSL 语法文档

## 1. 概述

PeekMatchRule 是一种领域特定语言(DSL)，用于定义二进制数据的模式匹配规则。该语言允许用户通过简单的语法描述复杂的数据匹配条件，并返回相应的类型标识。

## 2. 基本语法结构

### 2.1 基本匹配规则

```
GET(<偏移量>,<长度>) <操作符> <值> => <结果类型>
```

示例：

```
GET(0,4) == 'HEAD' => FILE_HEADER
GET(16,8) == 0x89504E470D0A1A0A => PNG_FILE
```

### 2.2 完整语法元素

| 元素     | 说明                | 示例                      |
|--------|-------------------|-------------------------|
| `GET`  | 关键字，表示从数据中获取指定部分  | `GET(0,4)`              |
| `偏移量`  | 数据起始位置(字节)        | `0` 表示从开头               |
| `长度`   | 要匹配的数据长度(字节)      | `4` 表示4字节               |
| `操作符`  | 比较操作符             | `==` (目前仅支持等于)          |
| `值`    | 要匹配的值，可以是字符串或十六进制 | `'HEAD'` 或 `0x89ABCDEF` |
| `=>`   | 结果指向符             |                         |
| `结果类型` | 匹配成功时返回的类型标识      | `FILE_HEADER`           |

## 3. 复合条件语法

### 3.1 逻辑运算符

| 运算符   | 说明  | 优先级 |
|-------|-----|-----|
| `and` | 逻辑与 | 高   |
| `or`  | 逻辑或 | 低   |
| `!`   | 逻辑非 | 最高  |

### 3.2 复合条件示例

```
GET(0,4) == 'HEAD' and GET(4,4) == 0x01020304 => TYPE_A
GET(0,2) == 0xFFD8 or GET(0,4) == 0x89504E47 => IMAGE_FILE
!(GET(0,8) == 'TRASHBIN') and GET(8,4) == 0x00000001 => VALID_FILE
```

### 3.3 分组条件

使用括号 `()` 可以明确运算优先级：

```
(GET(0,2) == 'AB' or GET(0,2) == 'CD') and GET(2,2) == 'EF' => TYPE_SPECIAL
```

## 4. 多规则定义

多个规则可以用换行符分隔：

```
GET(0,8) == 'FILE_HDR' => HEADER
GET(8,8) == 'DATA_BLK' => DATA_BLOCK
GET(16,8) == 'FILE_TRL' => TRAILER
```

## 5. 值类型说明

### 5.1 字符串值

- 用单引号 `'` 包围
- 区分大小写
- 示例：`'HEADER'`, `'File'`

### 5.2 十六进制值

- 以 `0x` 或 `0X` 开头
- 必须是偶数个十六进制字符
- 示例：`0x89ABCDEF`, `0XFFD8`

## 6. 使用示例

### 6.1 文件类型识别

```
GET(0,4) == '%PDF' => PDF_DOCUMENT
GET(0,4) == 0x89504E47 => PNG_IMAGE
GET(0,2) == 0xFFD8 => JPEG_IMAGE
GET(0,8) == 'SQLite f' => SQLITE_DB
```

### 6.2 协议消息识别

```
GET(0,1) == 0x01 and GET(1,2) == 0x0001 => HELLO_MSG
GET(0,1) == 0x02 and GET(1,4) == 0x0000000C => DATA_MSG
GET(0,1) == 0xFF => ERROR_MSG
```

### 6.3 复杂条件匹配

```
(GET(0,4) == 'RIFF' and GET(8,4) == 'WAVE') => WAV_FILE
(GET(0,4) == 'RIFF' and GET(8,4) == 'AVI ') => AVI_FILE
!(GET(0,3) == 0xEFBBBF) and GET(0,4) == '<?xm' => XML_FILE
```

## 7. 默认规则（通配符）

使用 `*` 作为通配符可以定义默认匹配规则，通常放在最后：

```
GET(0,8) == 'FILE_HDR' => HEADER
GET(8,8) == 'DATA_BLK' => DATA_BLOCK
* => UNKNOWN_TYPE
```

当所有前面的规则都不匹配时，会自动匹配通配符规则并返回 `UNKNOWN_TYPE`。

## 8. 注意事项

1. 偏移量和长度必须是正整数
2. 字符串比较是精确匹配，区分大小写
3. 十六进制值必须是完整字节(偶数个十六进制字符)
4. 规则按定义顺序依次匹配，返回第一个匹配成功的结果
5. 使用括号可以明确复杂条件的运算顺序

## 9. 最佳实践

1. 将最可能匹配的规则放在前面
2. 对固定格式的数据，优先匹配魔数(magic number)
3. 复杂的匹配条件可以分解为多个简单规则
4. 使用注释说明复杂规则的用途(虽然DSL本身不支持注释，但可以在规则文件上方添加说明)
